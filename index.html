<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SpotiClone - Your Music Universe</title>
    <style>
        :root {
            --spotify-green: #1db954;
            --spotify-green-hover: #1ed760;
            --bg-black: #121212;
            --bg-dark: #000000;
            --bg-light: #181818;
            --text-white: #ffffff;
            --text-gray: #b3b3b3;
            --border-gray: #282828;
            --hover-gray: #282828;
            --sidebar-width: 240px;
            --player-height: 90px;
            --transition-speed: 0.3s;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--bg-black) 0%, var(--bg-dark) 100%);
            color: var(--text-white);
            overflow: hidden;
            height: 100vh;
            display: grid;
            grid-template-areas: "sidebar main" "player player";
            grid-template-columns: var(--sidebar-width) 1fr;
            grid-template-rows: 1fr var(--player-height);
        }

        .sidebar {
            grid-area: sidebar;
            background-color: var(--bg-black);
            padding: 24px 12px;
            display: flex;
            flex-direction: column;
            gap: 24px;
            overflow-y: auto;
            border-right: 1px solid var(--border-gray);
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            color: var(--spotify-green);
            padding: 0 12px;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .logo::before {
            content: "üéµ";
            font-size: 28px;
        }

        .nav-item {
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all var(--transition-speed);
            display: flex;
            align-items: center;
            gap: 16px;
            color: var(--text-gray);
            font-weight: 500;
        }

        .nav-item:hover {
            background-color: var(--hover-gray);
            color: var(--text-white);
        }

        .nav-item.active {
            background-color: var(--hover-gray);
            color: var(--text-white);
        }

        .nav-item::before {
            font-size: 20px;
            width: 24px;
            text-align: center;
        }

        .nav-home::before { content: "üè†"; }
        .nav-search::before { content: "üîç"; }
        .nav-library::before { content: "üìö"; }

        .main-content {
            grid-area: main;
            overflow-y: auto;
            padding: 24px 32px;
            background: linear-gradient(to bottom, #1e3c72 0%, var(--bg-black) 300px);
        }

        .section {
            margin-bottom: 48px;
        }

        .section-title {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 24px;
            letter-spacing: -0.5px;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 24px;
        }

        .card {
            background-color: var(--bg-light);
            border-radius: 8px;
            padding: 16px;
            cursor: pointer;
            transition: all var(--transition-speed);
            position: relative;
        }

        .card:hover {
            background-color: var(--hover-gray);
            transform: translateY(-4px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
        }

        .card img {
            width: 100%;
            aspect-ratio: 1;
            object-fit: cover;
            border-radius: 4px;
            margin-bottom: 16px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.4);
        }

        .card h4 {
            font-size: 16px;
            margin-bottom: 4px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .card p {
            font-size: 14px;
            color: var(--text-gray);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .play-button {
            position: absolute;
            bottom: 16px;
            right: 16px;
            background-color: var(--spotify-green);
            border: none;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            opacity: 0;
            transform: translateY(8px);
            transition: all var(--transition-speed);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.6);
        }

        .card:hover .play-button {
            opacity: 1;
            transform: translateY(0);
        }

        .play-button:hover {
            background-color: var(--spotify-green-hover);
            transform: scale(1.06);
        }

        .play-button::after {
            content: "‚ñ∂";
            font-size: 18px;
            margin-left: 3px;
        }

        .search-container {
            display: none;
            flex-direction: column;
            gap: 24px;
        }

        .search-bar {
            position: sticky;
            top: 0;
            background-color: var(--bg-black);
            padding: 16px 0;
            z-index: 10;
        }

        .search-input {
            width: 100%;
            max-width: 600px;
            padding: 12px 24px;
            border-radius: 24px;
            border: none;
            background-color: var(--bg-light);
            color: var(--text-white);
            font-size: 14px;
            outline: none;
            transition: all var(--transition-speed);
        }

        .search-input:focus {
            background-color: var(--hover-gray);
            box-shadow: 0 0 0 2px var(--spotify-green);
        }

        .search-input::placeholder {
            color: var(--text-gray);
        }

        .search-results {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 16px;
        }

        .track-result {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color var(--transition-speed);
        }

        .track-result:hover {
            background-color: var(--hover-gray);
        }

        .track-result img {
            width: 56px;
            height: 56px;
            border-radius: 4px;
            object-fit: cover;
        }

        .track-info {
            flex: 1;
            min-width: 0;
        }

        .track-info h5 {
            font-size: 14px;
            margin-bottom: 4px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .track-info p {
            font-size: 12px;
            color: var(--text-gray);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .player {
            grid-area: player;
            background-color: var(--bg-dark);
            border-top: 1px solid var(--border-gray);
            display: grid;
            grid-template-columns: 1fr 2fr 1fr;
            align-items: center;
            padding: 0 16px;
        }

        .now-playing {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .now-playing img {
            width: 56px;
            height: 56px;
            border-radius: 4px;
        }

        .now-playing-info {
            min-width: 0;
        }

        .now-playing-info h5 {
            font-size: 14px;
            margin-bottom: 2px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .now-playing-info p {
            font-size: 12px;
            color: var(--text-gray);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .player-controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .control-buttons {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .control-btn {
            background: none;
            border: none;
            color: var(--text-gray);
            cursor: pointer;
            font-size: 18px;
            transition: color var(--transition-speed);
        }

        .control-btn:hover {
            color: var(--text-white);
        }

        .play-pause-btn {
            background-color: var(--text-white);
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--bg-dark);
        }

        .play-pause-btn:hover {
            transform: scale(1.06);
            background-color: var(--spotify-green);
        }

        .progress-bar {
            width: 100%;
            max-width: 600px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .time {
            font-size: 11px;
            color: var(--text-gray);
            min-width: 40px;
            text-align: center;
        }

        .progress-track {
            flex: 1;
            height: 4px;
            background-color: var(--border-gray);
            border-radius: 2px;
            cursor: pointer;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background-color: var(--text-white);
            border-radius: 2px;
            width: 0%;
            transition: width 0.1s;
        }

        .progress-track:hover .progress-fill {
            background-color: var(--spotify-green);
        }

        .volume-controls {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 8px;
        }

        @media (max-width: 768px) {
            body {
                grid-template-columns: 0 1fr;
            }
            .sidebar {
                position: absolute;
                left: -100%;
                z-index: 1000;
                height: calc(100vh - var(--player-height));
                transition: left var(--transition-speed);
            }
            .sidebar.open {
                left: 0;
            }
            .section-title {
                font-size: 24px;
            }
            .grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
                gap: 16px;
            }
        }

        .hidden {
            display: none !important;
        }

        /* LOGIN SCREEN */
        .login-container {
            position: fixed;
            inset: 0;
            background: var(--bg-black);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .login-box {
            text-align: center;
            padding: 48px;
            background: var(--bg-light);
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.5);
        }

        .login-btn {
            background: var(--spotify-green);
            color: var(--bg-dark);
            border: none;
            padding: 16px 48px;
            border-radius: 24px;
            font-weight: 700;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 24px;
        }

        .login-btn:hover {
            background: var(--spotify-green-hover);
            transform: scale(1.04);
        }
    </style>
</head>
<body>
    <!-- LOGIN SCREEN -->
    <div id="loginView" class="login-container">
        <div class="login-box">
            <h1>üéµ SpotiClone</h1>
            <p>Connect your Spotify account to start listening</p>
            <button id="loginBtn" class="login-btn">LOG IN WITH SPOTIFY</button>
        </div>
    </div>

    <!-- MAIN APP (Hidden until login) -->
    <div id="mainApp" class="hidden">
        <!-- SIDEBAR -->
        <aside class="sidebar" id="sidebar">
            <div class="logo">SpotiClone</div>
            <nav>
                <div class="nav-item nav-home active" data-view="home">
                    <span>Home</span>
                </div>
                <div class="nav-item nav-search" data-view="search">
                    <span>Search</span>
                </div>
                <div class="nav-item nav-library" data-view="library">
                    <span>Your Library</span>
                </div>
            </nav>
        </aside>

        <!-- MAIN CONTENT -->
        <main class="main-content" id="mainContent">
            <!-- HOME VIEW -->
            <div id="homeView" class="view">
                <section class="section">
                    <h2 class="section-title">Recently Played</h2>
                    <div class="grid" id="recentGrid"></div>
                </section>
                <section class="section">
                    <h2 class="section-title">Recommended for You</h2>
                    <div class="grid" id="recommendedGrid"></div>
                </section>
            </div>

            <!-- SEARCH VIEW -->
            <div id="searchView" class="view search-container">
                <div class="search-bar">
                    <input type="text" class="search-input" id="searchInput" placeholder="What do you want to listen to?">
                </div>
                <div class="search-results" id="searchResults"></div>
            </div>
        </main>

        <!-- PLAYER -->
        <div class="player" id="player">
            <div class="now-playing">
                <img id="nowPlayingArt" src="https://via.placeholder.com/56x56?text=‚ô™" alt="Album Art">
                <div class="now-playing-info">
                    <h5 id="nowPlayingTitle">No song playing</h5>
                    <p id="nowPlayingArtist">-</p>
                </div>
            </div>
            
            <div class="player-controls">
                <div class="control-buttons">
                    <button class="control-btn" id="shuffleBtn">üîÄ</button>
                    <button class="control-btn" id="prevBtn">‚èÆ</button>
                    <button class="control-btn play-pause-btn" id="playPauseBtn">‚ñ∂</button>
                    <button class="control-btn" id="nextBtn">‚è≠</button>
                    <button class="control-btn" id="repeatBtn">üîÅ</button>
                </div>
                <div class="progress-bar">
                    <span class="time" id="currentTime">0:00</span>
                    <div class="progress-track" id="progressTrack">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <span class="time" id="totalTime">0:30</span>
                </div>
            </div>
            
            <div class="volume-controls">
                <button class="control-btn" id="volumeBtn">üîä</button>
                <div class="progress-track" style="width: 100px;">
                    <div class="progress-fill" style="width: 70%;"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== CONFIGURATION ====================
        const BACKEND_URL = 'https://spoticlone-backend-production.up.railway.app';
        const CLIENT_ID = '4ef0b2e57bff49f88229c6f4a877dc21';
        const REDIRECT_URI = 'https://2625837.playcode.io/site';
        const SCOPES = 'user-read-private user-read-email streaming user-read-playback-state user-modify-playback-state';

        // ==================== STATE ====================
        const AppState = {
            accessToken: localStorage.getItem('spotify_access_token'),
            refreshToken: localStorage.getItem('spotify_refresh_token'),
            tokenExpiresAt: localStorage.getItem('spotify_token_expires'),
            currentSong: null,
            isPlaying: false,
            audio: new Audio(),
            progressInterval: null,
            recentlyPlayed: JSON.parse(localStorage.getItem('recentlyPlayed')) || []
        };

        // ==================== AUTHENTICATION ====================
        document.addEventListener('DOMContentLoaded', async () => {
            if (window.location.pathname.includes('callback')) {
                await handleCallback();
            } else if (!AppState.accessToken || isTokenExpired()) {
                showLogin();
            } else {
                showApp();
                initApp();
            }
        });

        function isTokenExpired() {
            return !AppState.tokenExpiresAt || Date.now() > parseInt(AppState.tokenExpiresAt);
        }

        function showLogin() {
            document.getElementById('loginView').style.display = 'flex';
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('loginBtn').onclick = login;
        }

        function showApp() {
            document.getElementById('loginView').style.display = 'none';
            document.getElementById('mainApp').classList.remove('hidden');
        }

        function login() {
            const authUrl = `https://accounts.spotify.com/authorize?client_id=${CLIENT_ID}&response_type=code&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&scope=${encodeURIComponent(SCOPES)}`;
            window.location.href = authUrl;
        }

        async function handleCallback() {
            const code = new URLSearchParams(window.location.search).get('code');
            if (!code) return;
            
            try {
                const res = await fetch(`${BACKEND_URL}/api/token`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code })
                });
                
                const data = await res.json();
                localStorage.setItem('spotify_access_token', `Bearer ${data.access_token}`);
                localStorage.setItem('spotify_refresh_token', data.refresh_token);
                localStorage.setItem('spotify_token_expires', Date.now() + (data.expires_in * 1000));
                
                window.history.replaceState({}, document.title, '/');
                location.reload();
            } catch (err) {
                alert('Login failed. Check console.');
                console.error(err);
            }
        }

        // ==================== APP INITIALIZATION ====================
        function initApp() {
            loadGrids();
            setupNavigation();
            setupSearch();
            setupPlayerControls();
            setupProgressBar();
            loadRecentlyPlayed();
        }

        // ==================== VIEW NAVIGATION ====================
        function setupNavigation() {
            const navItems = document.querySelectorAll('.nav-item');
            const views = document.querySelectorAll('.view');
            
            navItems.forEach(item => {
                item.addEventListener('click', () => {
                    const targetView = item.dataset.view;
                    navItems.forEach(nav => nav.classList.remove('active'));
                    item.classList.add('active');
                    views.forEach(view => view.style.display = 'none');
                    document.getElementById(`${targetView}View`).style.display = targetView === 'search' ? 'flex' : 'block';
                });
            });
        }

        // ==================== LOAD GRIDS ====================
        function loadGrids() {
            const recentGrid = document.getElementById('recentGrid');
            const recommendedGrid = document.getElementById('recommendedGrid');
            const recentSongs = AppState.recentlyPlayed.length > 0 ? AppState.recentlyPlayed : mockSongs.slice(0, 6);
            const recommendedSongs = mockSongs.slice(6);
            recentGrid.innerHTML = createCards(recentSongs);
            recommendedGrid.innerHTML = createCards(recommendedSongs);
        }

        function createCards(songs) {
            return songs.map(song => `
                <div class="card" onclick="playSong(${JSON.stringify(song).replace(/"/g, '&quot;')})">
                    <img src="${song.albumArt}" alt="${song.title}">
                    <h4>${song.title}</h4>
                    <p>${song.artist}</p>
                    <button class="play-button" onclick="event.stopPropagation(); playSong(${JSON.stringify(song).replace(/"/g, '&quot;')})"></button>
                </div>
            `).join('');
        }

        // ==================== SEARCH ====================
        function setupSearch() {
            const searchInput = document.getElementById('searchInput');
            let searchTimeout;
            
            searchInput.addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                const query = e.target.value.trim();
                if (query.length > 2) {
                    searchTimeout = setTimeout(() => performSearch(query), 500);
                } else if (query.length === 0) {
                    document.getElementById('searchResults').innerHTML = '';
                }
            });
        }

        async function performSearch(query) {
            if (!AppState.accessToken) return;
            
            const resultsContainer = document.getElementById('searchResults');
            
            try {
                const res = await fetch(`${BACKEND_URL}/api/spotify/v1/search?q=${encodeURIComponent(query)}&type=track&limit=20`, {
                    headers: { Authorization: AppState.accessToken }
                });
                
                const data = await res.json();
                AppState.searchResults = data.tracks.items.map(track => ({
                    id: track.id,
                    title: track.name,
                    artist: track.artists[0].name,
                    albumArt: track.album.images[0]?.url,
                    previewUrl: track.preview_url
                }));
                
                resultsContainer.innerHTML = AppState.searchResults.map(song => `
                    <div class="track-result" onclick="playSong(${JSON.stringify(song).replace(/"/g, '&quot;')})">
                        <img src="${song.albumArt}" alt="${song.title}">
                        <div class="track-info">
                            <h5>${song.title}</h5>
                            <p>${song.artist}</p>
                        </div>
                    </div>
                `).join('');
            } catch (err) {
                console.error('Search failed:', err);
            }
        }

        // ==================== PLAYER CONTROLS ====================
        function setupPlayerControls() {
            const playPauseBtn = document.getElementById('playPauseBtn');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            
            playPauseBtn.addEventListener('click', togglePlayPause);
            prevBtn.addEventListener('click', playPrevious);
            nextBtn.addEventListener('click', playNext);
            
            AppState.audio.addEventListener('ended', () => {
                AppState.isPlaying = false;
                updatePlayPauseButton();
                clearInterval(AppState.progressInterval);
            });
        }

        function playSong(song) {
            AppState.audio.pause();
            clearInterval(AppState.progressInterval);
            AppState.currentSong = song;
            AppState.isPlaying = true;
            document.getElementById('nowPlayingArt').src = song.albumArt;
            document.getElementById('nowPlayingTitle').textContent = song.title;
            document.getElementById('nowPlayingArtist').textContent = song.artist;
            AppState.audio.src = song.previewUrl;
            AppState.audio.play().catch(() => alert('Playback failed'));
            updatePlayPauseButton();
            startProgressTracking();
            addToRecentlyPlayed(song);
        }

        function togglePlayPause() {
            if (!AppState.currentSong) return playSong(mockSongs[0]);
            AppState.isPlaying ? AppState.audio.pause() : AppState.audio.play();
            AppState.isPlaying = !AppState.isPlaying;
            updatePlayPauseButton();
        }

        function playPrevious() {
            if (!AppState.currentSong) return;
            const currentIndex = mockSongs.findIndex(s => s.id === AppState.currentSong.id);
            const prevIndex = currentIndex > 0 ? currentIndex - 1 : mockSongs.length - 1;
            playSong(mockSongs[prevIndex]);
        }

        function playNext() {
            if (!AppState.currentSong) return;
            const currentIndex = mockSongs.findIndex(s => s.id === AppState.currentSong.id);
            const nextIndex = currentIndex < mockSongs.length - 1 ? currentIndex + 1 : 0;
            playSong(mockSongs[nextIndex]);
        }

        function updatePlayPauseButton() {
            document.getElementById('playPauseBtn').textContent = AppState.isPlaying ? '‚è∏' : '‚ñ∂';
        }

        function startProgressTracking() {
            clearInterval(AppState.progressInterval);
            AppState.progressInterval = setInterval(() => {
                if (AppState.audio.duration) {
                    const progress = (AppState.audio.currentTime / AppState.audio.duration) * 100;
                    document.getElementById('progressFill').style.width = progress + '%';
                    document.getElementById('currentTime').textContent = formatTime(AppState.audio.currentTime);
                }
            }, 100);
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function setupProgressBar() {
            const progressTrack = document.getElementById('progressTrack');
            progressTrack.addEventListener('click', (e) => {
                if (!AppState.audio.duration) return;
                const rect = progressTrack.getBoundingClientRect();
                const percentage = (e.clientX - rect.left) / rect.width;
                AppState.audio.currentTime = percentage * AppState.audio.duration;
            });
        }

        function addToRecentlyPlayed(song) {
            AppState.recentlyPlayed = AppState.recentlyPlayed.filter(s => s.id !== song.id);
            AppState.recentlyPlayed.unshift(song);
            AppState.recentlyPlayed = AppState.recentlyPlayed.slice(0, 10);
            localStorage.setItem('recentlyPlayed', JSON.stringify(AppState.recentlyPlayed));
        }

        function loadRecentlyPlayed() {
            const recentGrid = document.getElementById('recentGrid');
            if (AppState.recentlyPlayed.length > 0) {
                recentGrid.innerHTML = createCards(AppState.recentlyPlayed);
            }
        }

        // ====4================ MOCK DATA ====================
        const mockSongs = [
            { id: 1, title: "Midnight Dreams", artist: "Luna Echo", albumArt: "https://picsum.photos/seed/music1/200/200.jpg", previewUrl: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3" },
            { id: 2, title: "Electric Pulse", artist: "Neon Lights", albumArt: "https://picsum.photos/seed/music2/200/200.jpg", previewUrl: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3" },
            { id: 3, title: "Summer Breeze", artist: "Tropical Vibes", albumArt: "https://picsum.photos/seed/music3/200/200.jpg", previewUrl: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-3.mp3" },
            { id: 4, title: "City Lights", artist: "Urban Soul", albumArt: "https://picsum.photos/seed/music4/200/200.jpg", previewUrl: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-4.mp3" },
            { id: 5, title: "Ocean Waves", artist: "Coastal Sounds", albumArt: "https://picsum.photos/seed/music5/200/200.jpg", previewUrl: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-5.mp3" },
            { id: 6, title: "Starlight", artist: "Cosmic Journey", albumArt: "https://picsum.photos/seed/music6/200/200.jpg", previewUrl: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-6.mp3" }
        ];
    </script>
</body>
</html>
